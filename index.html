<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>內部公告欄</title>
    <style>
        /* CSS 樣式完全不變 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f4f4f8; color: #333; }
        header { background-color: #4a69bd; color: white; padding: 20px; text-align: center; font-size: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        main { padding: 15px; max-width: 600px; margin: 0 auto; }
        .controls { background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        #admin-login-btn { background-color: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; float: right; }
        #admin-login-btn.logout { background-color: #dc3545; }
        #search-input { width: calc(100% - 100px); padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #admin-form { display: none; margin-top: 15px; clear: both; }
        #admin-form input, #admin-form textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        #admin-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        #admin-form button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #announcement-list { list-style: none; padding: 0; }
        .announcement-item { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .announcement-image { max-width: 100%; border-radius: 4px; margin-top: 10px; }
        .announcement-item h3 { margin-top: 0; color: #4a69bd; }
        .announcement-item p { margin-bottom: 5px; white-space: pre-wrap; }
        .announcement-item footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; flex-wrap: wrap; gap: 10px;}
        .announcement-item .date { font-size: 12px; color: #888; }
        .sign-status { font-size: 14px; font-weight: bold; text-align: right; }
        .sign-status .sign-count { color: #007bff; cursor: pointer; text-decoration: underline; }
        .sign-status .sign-button { background-color: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body>

    <header>內部公告欄</header>
    <main>
        <div class="controls">
            <button id="admin-login-btn">管理員登入</button>
            <input type="text" id="search-input" placeholder="搜尋公告...">
            <form id="admin-form">
                <h3 style="margin-top: 20px;">發布新公告</h3>
                <label for="new-title">標題</label>
                <input type="text" id="new-title" required>
                <label for="new-content">內容</label>
                <textarea id="new-content" rows="4" required></textarea>
                <label for="new-image">上傳圖片 (選填)</label>
                <input type="file" id="new-image" accept="image/*">
                <button type="submit">發布</button>
            </form>
        </div>
        <ul id="announcement-list"></ul>
    </main>

    <script>
    // === 資料區 ===
    const employees = [ { id: '1001', name: '王大明' }, { id: '1002', name: '陳靜香' }, { id: '1003', name: '李志偉' }, { id: '1004', name: '林美玲' }, { id: '1005', name: '黃俊彥' }, { id: '1006', name: '張雅婷' }, { id: '1007', name: '劉建宏' }, { id: '1008', name: '許惠君' }, { id: '1009', name: '吳宗憲' }, { id: '1010', name: '蔡依林' }, { id: '1011', name: '周杰倫' }, { id: '1012', name: '孫燕姿' }, { id: '1013', name: '林俊傑' }, { id: '1014', name: '王心凌' }, { id: '1015', name: '潘瑋柏' }, { id: '1016', name: '張韶涵' }, { id: '1017', name: '楊丞琳' }, { id: '1018', name: '羅志祥' }, { id: '1019', name: '蕭亞軒' }];
    
    // ** 【修改重點 1】: announcements 陣列現在只是一個空殼，資料會從下方函式載入 **
    let announcements = [];

    // === 狀態變數 ===
    let isAdminLoggedIn = false;

    // === 程式初始化 ===
    window.addEventListener('load', function() {
        // ** 【修改重點 2】: 頁面載入時，先去初始化公告資料 **
        initializeAnnouncements();
        setupEventListeners();
        renderAnnouncements();
    });

    // ** 【修改重點 3】: 新增一個函式，專門用來從 localStorage 載入公告 **
    function initializeAnnouncements() {
        const savedAnnouncements = localStorage.getItem('announcements');
        if (savedAnnouncements) {
            // 如果 localStorage 裡有資料，就用它
            announcements = JSON.parse(savedAnnouncements);
        } else {
            // 如果沒有，就使用預設的資料，並存入 localStorage 當作種子資料
            announcements = [ { id: 1, title: "【重要】系統維護通知", content: "本公司伺服器將於 10月10日 凌晨 02:00 至 04:00 進行例行維護。", date: "2025-10-08", image: null }, { id: 2, title: "【活動】員工旅遊意願調查", content: "為了規劃今年的員工旅遊，請各位同仁填寫意願調查表單。", date: "2025-10-07", image: null }, { id: 3, title: "【福利】健康檢查結果領取通知", content: "年度健康檢查報告已可領取，請攜帶員工證至人資部。", date: "2025-10-06", image: null } ];
            localStorage.setItem('announcements', JSON.stringify(announcements));
        }
    }

    // === 功能函式 (除了 addAndRender 外，其他不變) ===
    function setupEventListeners() { /* ... 內容不變 ... */ document.getElementById('admin-login-btn').addEventListener('click', handleAdminAuth); document.getElementById('search-input').addEventListener('input', renderAnnouncements); document.getElementById('admin-form').addEventListener('submit', function(event) { event.preventDefault(); addNewAnnouncement(); }); }
    function renderAnnouncements() { /* ... 內容不變 ... */ const listElement = document.getElementById('announcement-list'); const searchTerm = document.getElementById('search-input').value.toLowerCase(); const signRecords = getSignRecords(); const filteredAnnouncements = announcements.filter(item => item.title.toLowerCase().includes(searchTerm) || item.content.toLowerCase().includes(searchTerm)); listElement.innerHTML = ''; if (filteredAnnouncements.length === 0) { listElement.innerHTML = '<p style="text-align: center; color: #888;">找不到符合的公告。</p>'; return; } for (const item of filteredAnnouncements) { const signedEmployeeIds = signRecords[item.id] || []; const imageHTML = item.image ? `<img src="${item.image}" class="announcement-image" alt="公告圖片">` : ''; const listItem = document.createElement('li'); listItem.className = 'announcement-item'; listItem.innerHTML = `<h3>${item.title}</h3><p>${item.content}</p>${imageHTML}<footer><span class="date">${item.date}</span><div class="sign-status"><span class="sign-count" onclick="showSignedEmployees(${item.id})">${signedEmployeeIds.length} / ${employees.length} 人已讀</span><button class="sign-button" onclick="promptToSign(${item.id})">簽到</button></div></footer>`; listElement.appendChild(listItem); } }
    function handleAdminAuth() { /* ... 內容不變 ... */ if (isAdminLoggedIn) { isAdminLoggedIn = false; alert('您已成功登出。'); } else { const username = prompt('請輸入管理員帳號:'); const password = prompt('請輸入管理員密碼:'); if (username === 'admin' && password === 'admin') { isAdminLoggedIn = true; alert('管理員登入成功！'); } else { alert('帳號或密碼錯誤！'); } } updateAdminUI(); }
    function updateAdminUI() { /* ... 內容不變 ... */ const loginBtn = document.getElementById('admin-login-btn'); const adminForm = document.getElementById('admin-form'); if (isAdminLoggedIn) { loginBtn.textContent = '登出'; loginBtn.classList.add('logout'); adminForm.style.display = 'block'; } else { loginBtn.textContent = '管理員登入'; loginBtn.classList.remove('logout'); adminForm.style.display = 'none'; } }
    function addNewAnnouncement() { /* ... 內容不變 ... */ const title = document.getElementById('new-title').value; const content = document.getElementById('new-content').value; const imageFile = document.getElementById('new-image').files[0]; if (!title || !content) { alert('標題和內容不可為空！'); return; } if (imageFile) { const reader = new FileReader(); reader.readAsDataURL(imageFile); reader.onload = function() { const newAnnouncement = { id: Date.now(), title: title, content: content, date: new Date().toISOString().split('T')[0], image: reader.result }; addAndRender(newAnnouncement); }; } else { const newAnnouncement = { id: Date.now(), title: title, content: content, date: new Date().toISOString().split('T')[0], image: null }; addAndRender(newAnnouncement); } }
    
    function addAndRender(newAnnouncement) {
        announcements.unshift(newAnnouncement);
        
        // ** 【修改重點 4】: 將更新後的公告陣列，存回 localStorage **
        localStorage.setItem('announcements', JSON.stringify(announcements));

        document.getElementById('admin-form').reset();
        renderAnnouncements();
    }
    
    function promptToSign(announcementId) { /* ... 內容不變 ... */ const employeeId = prompt("請輸入您的人事號以完成簽到："); if (!employeeId) return; const employee = employees.find(emp => emp.id === employeeId.trim()); if (!employee) { alert(`錯誤：人事號 "${employeeId}" 不存在！`); return; } let signRecords = getSignRecords(); const signedEmployeeIds = signRecords[announcementId] || []; if (signedEmployeeIds.includes(employeeId.trim())) { alert(`${employee.name}，您已簽到過此公告。`); return; } if (!signRecords[announcementId]) { signRecords[announcementId] = []; } signRecords[announcementId].push(employeeId.trim()); localStorage.setItem('signRecords', JSON.stringify(signRecords)); alert(`${employee.name}，簽到成功！`); renderAnnouncements(); }
    function showSignedEmployees(announcementId) { /* ... 內容不變 ... */ const signRecords = getSignRecords(); const signedEmployeeIds = signRecords[announcementId] || []; if (signedEmployeeIds.length === 0) { alert("目前尚無人簽到此公告。"); return; } const signedNames = signedEmployeeIds.map(id => { const employee = employees.find(emp => emp.id === id); return employee ? employee.name : "未知員工"; }).join("、"); alert(`已簽到人員：\n${signedNames}`); }
    function getSignRecords() { /* ... 內容不變 ... */ const stored = localStorage.getItem('signRecords'); return stored ? JSON.parse(stored) : {}; }
    </script>
</body>
</html>
